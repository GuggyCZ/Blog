<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Projekt Atropa (5): Vytváříme honeypot | ALTAIR.blog</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <meta name="Description" content="V předchozích dílech seriálu o vytvoření &quot;zlé maliny&quot; jsme si ukázali, jak na Raspberry Pi nainstalovat operační systém Raspbian, ASP.NET 5 a jak aplikaci pomocí nginxu vypublikovat do Internetu. Dnes z Raspberry vytvoříme Wi-Fi honeypot, tedy Wi-Fi access point, který každému dovolí, aby se připojil, a všechny HTTP požadavky bude směřovat sám na sebe." />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/Content/Images/logo_onwhite.svg" alt="altair.blog" style="height:100px;" />
        </a>
      </div>
    </header>
    <main>
      <h1>Projekt Atropa (5): Vytváříme honeypot</h1>
      <section class="article">
        <p>V předchozích dílech seriálu o vytvoření &quot;zlé maliny&quot; jsme si ukázali, jak na Raspberry Pi nainstalovat operační systém Raspbian, ASP.NET 5 a jak aplikaci pomocí nginxu vypublikovat do Internetu. Dnes z Raspberry vytvoříme Wi-Fi honeypot, tedy Wi-Fi access point, který každému dovolí, aby se připojil, a všechny HTTP požadavky bude směřovat sám na sebe.</p>
<h2 id="umi-moje-wi-fi-rezim-ap">Umí moje Wi-Fi režim AP?</h2>
<p>Základem úspěchu je mít Wi-Fi síťovou kartu, která podporuje AP režim. V <a href="http://www.aspnet.cz/articles/5429-projekt-atropa-1-jak-vyrobit-z-raspberry-pi-zle-zarizeni-s-netem">úvodním dílu</a> jsem doporučoval <a href="https://www.alza.cz/tp-link-tl-wn722n-lite-d155291.htm">TP-LINK TL-WN722N</a> a ten AP umí. Pokud budete mít jinou a nejste si jisti, zkontrolujte to.</p>
<p>Začněte tím, že příkazem <code>sudo apt-get install iw -y</code> nainstalujete utilitu <code>iw</code>, která umí mimo jiné vypsat schopnosti vaší Wi-Fi. Poté si příkazem <code>iw list</code> vypište všechny Wi-Fi ve vašem systému a jejich schopnosti.</p>
<p>Najděte sekci <em>Supported interface modes</em> a v ní hledejte režim <em>AP</em>. Pokud ho nenajdete, kupte si jinou kartu.</p>
<h2 id="vytvoreni-wi-fi-ap-pomoci-hostapd">Vytvoření Wi-Fi AP pomocí hostapd</h2>
<p>V celém návodu budu předpokládat, že se vaše Wi-Fi karta jmenuje <code>wlan0</code>, což je nejspíš pravda (pokud máte v systému jedinou kartu). Pokud si nejste jisti, zjistěte to příkazem <code>iwconfig</code>, který vypíše všechny bezdrátové síťovky ve vašem systému:</p>
<p><em>pi@raspberrypi ~ $</em> <strong>iwconfig</strong> wlan0 IEEE 802.11bgn ESSID:off/any Mode:Managed Access Point: Not-Associated Tx-Power=20 dBm Retry short limit:7 RTS thr:off Fragment thr:off Power Management:off lo no wireless extensions. eth0 no wireless extensions.</p>
<p><code>Hostapd</code> je program, který z vašeho Raspberry Pi udělá Wi-Fi přístupový bod. Nainstalujte ho příkazem <code>sudo apt-get install hostapd -y</code>. Dále pak vytvořte jeho konfigurační soubor příkazem <code>sudo nano /etc/hostapd/hostapd.conf</code>. Zadejte do něj následující obsah:</p>
<p>interface=wlan0 driver=nl80211 ssid=Internet channel=6</p>
<p>Poté změny uložte (Ctrl+X, Y, ENTER). Význam parametrů je následující:</p>
<ul>
<li><code>interface</code> je název rozhraní, v našem případě tedy <code>wlan0</code>.</li>
<li><code>driver</code> je název ovladače. Pokud nemáte opravdu starou nebo opravdu divnou kartu, bude to <code>nl80211</code>.</li>
<li><code>ssid</code> je název sítě, zde <code>Internet</code>.</li>
<li><code>channel</code> je číslo kanálu. Zvolte takový, který nebude kolidovat se sítěmi ve vašem okolí.</li>
</ul>
<p>Dále musíme hostapd říct, kde konfiguraci najde. Příkazem <code>sudo nano /etc/init.d/hostapd</code> otevřete jeho spouštěcí skript a najděte řádek, který začíná <code>DAEMON_CONF=</code>. Za rovnítko napište cestu ke konfiguračnímu souboru. Celý řádek tedy bude vypadat tako:</p>
<p>DAEMON_CONF=/etc/hostapd/hostapd.conf</p>
<p>Poté změny uložte (Ctrl+X, Y, ENTER).</p>
<p>Příkazem <code>sudo update-rc.d hostapd defaults</code> nastavte, aby se hostapd automaticky nastartoval po rebootu.</p>
<p>Tímto jsme náš počítač zkonfigurovali jako AP pro síť Internet, která je zcela otevřená (bez hesla). Zatím ho ale nebudeme startovat, protože by se klienti stejně nemohli připojit, protože by nedostali adresu přes DHCP.</p>
<h2 id="instalace-a-konfigurace-dnsmasq">Instalace a konfigurace dnsmasq</h2>
<p>Dnsmasq je program, který funguje jako jednoduchý DNS a DHCP server. Nainstalujte ho příkazem <code>sudo apt-get install dnsmasq -y</code>. Poté otevřete jeho konfigurační soubor příkazem <code>sudo nano /etc/dnsmasq.conf</code>. Na konec souboru přidejte následující:</p>
<p>log-facility=/var/log/dnsmasq.log address=/#/10.0.0.1 interface=wlan0 dhcp-range=10.0.0.10,10.0.0.250,1h no-resolv log-queries</p>
<p>Poté změny uložte (Ctrl+X, Y, ENTER). Tento zápis všem připojeným přes interface <code>wlan0</code> přidělí IP adresu z rozsahu <code>10.0.0.100-250</code> a na všechny DNS dotazy bude odpovídat adresou <code>10.0.0.1</code>. To bude adresa našeho počítače, takže ať už se uživatel zeptá na cokoliv, bude přesměrován na náš lokální web server. Dále pak budeme všechny DNS dotazy ukládat do souboru <code>/var/log/dnsmasq.log</code>.</p>
<p>Příkazem <code>sudo update-rc.d dnsmasq defaults</code> nastavte, aby se dnsmasq automaticky nastartoval po rebootu.</p>
<h2 id="nastaveni-site-a-firewallu">Nastavení sítě a firewallu</h2>
<p>Začneme tím, že na firewallu zakážeme pro rozhraní wlan0 všechny porty, s výjimkou HTTP, DHCP a DNS. Zadejte následující příkazy:</p>
<p>sudo iptables -F sudo iptables -i wlan0 -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT sudo iptables -i wlan0 -A INPUT -p udp --dport 53 -j ACCEPT sudo iptables -i wlan0 -A INPUT -p udp --dport 67:68 -j ACCEPT sudo iptables -i wlan0 -A INPUT -p tcp --dport 80 -j ACCEPT sudo iptables -i wlan0 -A INPUT -j DROP sudo sh -c &quot;iptables-save &gt; /etc/iptables.rules&quot;</p>
<p>Těmi nastavíte, že se budou zahazovat všechny pakety mimo DNS (port 53 UDP), DHCP (porty 67-68 UDP) a HTTP (port 80 TCP). Nastavení platí pouze pro rozhraní <code>wlan0</code>, takže přes drátový Ethernet bude možné se nadále normálně připojit. Posledním příkazem nastavení iptables vyexportujete do souboru <code>/etc/iptables.rules</code>, ze kterého je budeme později načítat.</p>
<p>Dále pak nastavíme naší bezdrátové kartě pevnou IP adresu 10.0.0.1 a zajistíme, že se při startu načtou shora uvedená pravidla. Editujte konfigurační soubor příkazem <code>sudo nano /etc/network/interfaces</code>. V tomto souboru vymažte celou sekci týkající se rozhraní <code>wlan0</code> (celý řádek smažete pomocí Ctrl+K). Místo ní zadejte tučný text v následujícím výpisu (který zahrnuje pro informaci i konfiguraci ostatních rozhraní, tedy celý soubor na mém RPi):</p>
<p>auto lo iface lo inet loopback auto eth0 allow-hotplug eth0 iface eth0 inet manual <strong>iface wlan0 inet static address 10.0.0.1 netmask 255.255.255.0 broadcast 255.0.0.0 pre-up iptables-restore &lt; /etc/iptables.rules</strong> auto wlan1 allow-hotplug wlan1 iface wlan1 inet manual wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</p>
<p>Poté změny uložte (Ctrl+X, Y, ENTER).</p>
<p>Poslední věc, kterou je třeba zajistit je, abychom se nestali obětí vlastního honeypotu. Tedy aby Raspberry Pi samo dokázalo udělat funkční DNS resolving a neresolvovalo vše samo na sebe. Nastavíme tedy, že bude napevno používat DNS server Google. Příkazem <code>sudo nano /etc/resolvconf.conf</code> otevřete konfigurační soubor, odkomentujte řádek začínající <code>#name_servers=</code> a místo <code>127.0.0.1</code> zadejte adresu DNS serveru, který chcete používat, např. <code>8.8.8.8</code>. Celý soubor bude po provedení změn vypadat takto:</p>
<h1 id="configuration-for-resolvconf8-see-resolvconf.conf5-for-details-resolv_confetcresolv.conf-if-you-run-a-local-name-server-you-should-uncomment-the-below-line-and-configure-your-subscribers-configuration-files-below.name_servers8.8.8.8-mirror-the-debian-package-defaults-for-the-below-resolvers-so-that-resolvconf-integrates-seemlessly.dnsmasq_resolvvarrundnsmasqresolv.conf-pdnsd_confetcpdnsd.conf-unbound_confvarcacheunboundresolvconf_resolvers.conf">Configuration for resolvconf(8) # See resolvconf.conf(5) for details resolv_conf=/etc/resolv.conf # If you run a local name server, you should uncomment the below line and # configure your subscribers configuration files below. <strong>name_servers=8.8.8.8</strong> # Mirror the Debian package defaults for the below resolvers # so that resolvconf integrates seemlessly. dnsmasq_resolv=/var/run/dnsmasq/resolv.conf pdnsd_conf=/etc/pdnsd.conf unbound_conf=/var/cache/unbound/resolvconf_resolvers.conf</h1>
<p>Poté změny uložte (Ctrl+X, Y, ENTER).</p>
<h2 id="zkouska-honeypotu">Zkouška honeypotu</h2>
<p>Začněte tím, že Raspberry restarujtete příkazem <code>sudo reboot</code>. Vyčkejte, dokud nenastartuje. Poté se připojte k otevřené síti Internet (nebo jak jste ji pojmenovali) a zadejte do browseru jakoukoliv webovou adresu. Budete přesměrováni na výchozí stránku naší ukázkové ASP.NET aplikace.</p>
<p>V příštím pokračování si ukážeme, jak napsat aplikaci tak, aby sbírala hesla uživatelů.</p>

      </section>
    </main>
    <footer>
      Footer
    </footer>
  </body>
</html>