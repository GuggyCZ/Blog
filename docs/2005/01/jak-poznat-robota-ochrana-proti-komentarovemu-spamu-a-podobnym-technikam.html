<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Jak poznat robota - ochrana proti komentářovému spamu a podobným technikám | ALTAIR.blog</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <meta name="Description" content="ASP.NET a ochrana proti robotům pomocí opisování kódu z generovaného obrázku" />
    <link rel="stylesheet" type="text/css" href="/content/styles.min.css" />
    <link rel="alternate" type="application/rss+xml" href="/feed.rss" title="RSS Feed" />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/content/images/logo_onwhite.svg" alt="altair.blog" style="height:100px;" />
        </a>
      </div>
    </header>
    <main>
      <h1>Jak poznat robota - ochrana proti komentářovému spamu a podobným technikám</h1>
      <section class="article">
        <p>Nafouknutá bublina optimalizace pro vyhledávače (<acronym title="Search Engine Optimization">SEO</acronym>) přinesla fenomén <em>komentářového spamu</em> - tedy robotů, kteří automatizovaně vkládají odkazy na své weby do každého diskusního fóra, na které narazí, a které se jim podaří objevit. To vedlo k nebývalému rozšíření technik, které slouží k odhalení, který z návštěvníků je robot. Nejedná se samozřejmě o jedinou oblast využití - stejnou metodu používají mobilní operátoři aby zabránili automatizovanému rozesílání SMS přes své webové brány nebo <a href="http://www.uoou.cz/int/spam_stiznost.php3">Úřad pro ochranu osobních údajů</a> na rozhraní pro elektronické podání stížnosti na spammery.</p>
<h2 id="principy-fungovani">Principy fungování</h2>
<p>Základním principem je položit takovou otázku, na kterou člověk dokáže snadno odpovědět, ale robot ne. Příkladem může být například systém komentářů na <a href="http://blog.czhannes.com/index.php?p=575&amp;c=1#comments">Game Blogu</a>. Na něm musíte pro odeslání komentáře doplnit logickou dvojici &quot;<em>kočka a ???</em>&quot;. Už přidaná poznámka <em>není to &quot;kocour&quot; ani &quot;myš&quot;</em> ukazuje na jednu ze slabin tohoto systému: ne každý pochopí, co jste chtěli sdělit - třeba z jazykových nebo kulturních důvodů. Další nevýhodou je skutečnost, že otázka a odpověď je vždy stejná (nebo se maximálně střídá několik málo otázek). Obrana je účinná proti generickým spamovacím robotům, ale nikoliv proti útoku cílenému na tento web.</p>
<p>Mnohem častěji se používá techniky, kdy je uživateli zobrazen automaticky generovaný obrázek s nějakým slovem či kódem. Člověk ho snadno přečte a opíše do textového pole, robot ale nikoliv. Není to ale nemožné - pokud je text napsán běžným způsobem, lze vcelku jednoduše napsat <acronym title="Optical Character Recognition - optické rozpoznávání písma">OCR</acronym> algoritmus, který obrázek analyzuje a text přečte. Proto se v praxi obvykle přidává jistý prvek náhodnosti - různé fonty, barvy, velikosti či přidání šumu - který složitost tvorby takového algoritmu výrazně zvyšuje.</p>
<h2 id="konkretni-reseni">Konkrétní řešení</h2>
<p>Nabízím vám implementaci obrázkového generátoru v prostředí ASP.NET. Vyznačuje se následujícími vlastnostmi:</p>
<ul>
<li>Barva, typ písma a jeho velikost se určují náhodně. Do obrázku je přidáván šum, který znesnadňuje automatickou analýzu. Implementace je provedena formou <em>web user controlu</em> a validátorů takže stačí tento prvek umístit na formulář a testovat validitu stránky jako obvykle (<code>Page.IsValid</code>). Pokud uživatel zadá kód nesprávně, pro další pokus se vygeneruje nový obrázek. Za prvé to znesnadňuje práci případným robotům (mají jenom jeden pokus). Za druhé, je-li shodou náhod vygenerován obrázek který je obtížně čitelný pro člověka, je při dalším pokusu vygenerováno něco jiného, pravděpodobně čitelnějšího.</li>
</ul>
<p>Řešení sestává ze dvou částí. První část je zmiňovaný web user control (<code>HumanFilter.ascx</code>), který obsahuje odkaz na obrázek, textové pole a logiku validace. Druhou komponentou je ASPX stránka (<code>HumanFilterImageGenerator.aspx</code>), která na požádání vygeneruje náhodný obrázek.</p>
<p>Drobný problém spočívá v propojení user controlu a obrázkového generátoru. Generátoru je třeba sdělit, jaký kód má zobrazit (a to se v nějaké formě musí posílat přes klienta v počítači srozumitelném tvaru), ale zároveň klient nesmí být ze zadání schopen automaticky vygenerovat odpověď. Jako nejjednodušší řešení jsem zvolil své oblíbené <a href="http://archive.aspnetwork.cz/art/clanek.asp?id=255">hashování se solí</a>. Zcela veřejně a nezakrytě (jako součást URL) posílám číselný kód. K němu na straně serveru připojím tajný řetězec (&quot;sůl&quot;) a poté spočítám MD5 hash. Prvních několik jeho znaků pak musí uživatel opsat. Bez znalosti &quot;soli&quot; nelze hash spočítat.</p>
<h3 id="konfigurace">Konfigurace</h3>
<p>Konfigurace jest prováděna prostřednictvím čtyř konfiguračních proměnných, které jest ukládati do sekce <code>configuration/appSettings</code> souboru <code>Web.Config</code>:</p>
<p><add key="HumanFilter.CodeLength" value="5" /> <add key="HumanFilter.Salt" value="demo" /> <add key="HumanFilter.ImageGenerator" value="HumanFilterImageGenerator.aspx" /> <add key="HumanFilter.Fonts" value="Arial;Arial Black;Palatino;Comic Sans;Courier;Georgia;Impact;Lucida Console;Tahoma;Times;Trebuchet;Verdana" /></p>
<p>Význam proměnných je následující:</p>
<ul>
<li><code>HumanFilter.CodeLength</code> - délka opisovaného řetězce, doporučuji 4-8 znaků. <code>HumanFilter.Salt</code> - znění &quot;soli&quot;, řetězce přidávaného při hashování. <code>HumanFilter.ImageGenerator</code> - URL stránky, která generuje obrázek. <code>HumanFilter.Fonts</code> - Středníkem oddělený seznam názvů písem, které se mají použít při vytváření obrázku. V příkladu výše uvedený seznam obsahuje fonty standardně distribuované s Windows 2003. Rozhodl jsem se výběr fontů nechat na uživateli, místo abych náhodně vybíral ze všech instalovaných fontů, protože některé obskurnější fonty nemusejí být pro tento účel vhodné.</li>
</ul>
<h3 id="web-user-control-humanfilter.ascx-humanfilter.ascx.vb">Web user control - HumanFilter.ascx, HumanFilter.ascx.vb</h3>
<p>Zdrojový kód HTML části je jednoduchý:</p>
<table> <tr> <td><asp:image id="ImageCode" runat="server"></asp:image></td> <td><asp:textbox id="TextBoxCode" runat="server"></asp:textbox></td> <td> <asp:regularexpressionvalidator id="RegularExpressionValidator1" runat="server" errormessage="Ověřovací kód obsahuje jiné než povolené znaky (pouze 0-9, A-F)" display="Dynamic" controltovalidate="TextBoxCode" validationexpression="[0-9A-Fa-f]{1,}">*</asp:regularexpressionvalidator> <asp:requiredfieldvalidator id="RequiredFieldValidator1" runat="server" errormessage="Není zadán ověřovací kód" display="Dynamic" controltovalidate="TextBoxCode">*</asp:requiredfieldvalidator> <asp:customvalidator id="CustomValidator1" runat="server" errormessage="Ověřovací kód je zadán chybně" display="Dynamic" controltovalidate="TextBoxCode">*</asp:customvalidator> </td> </tr> </table> 
<p>Control obsahuje tabulku, ve které se nachází v řadě obrázek, textové pole a trojice validátorů. První dva jsou tam spíše pro komfort uživatele, kontrolují zda je pole vyplněno a zda obsahuje jenom povolené znaky (0-9 a A-F). Veškerou &quot;špinavou práci&quot; odvádí třetí, CustomValidator, který na straně serveru porovnává zadaný kód s tím správným. Také v případě chybně zadaného kódu generuje nový. Obslužný programový kód vypadá takto:</p>
<p>Private Rnd As New System.Random Private Sub Page_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load If Page.IsPostBack Then Return ' Generate base for random code and save it to viewstate Dim Code As Int32 = Me.Rnd.Next() Me.ViewState.Add(&quot;Code&quot;, Code) ' Setup image display Me.ImageCode.Width = New System.Web.UI.WebControls.Unit(Int32.Parse(System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.CodeLength&quot;)) * 20) Me.ImageCode.Height = New System.Web.UI.WebControls.Unit(30) Me.ImageCode.ImageUrl = System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.ImageGenerator&quot;) &amp; &quot;?Code=&quot; &amp; Code End Sub Friend Shared Function GetVerificationString(ByVal Code As Int32) As String ' Compute hash with salt Dim R As String = System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.Salt&quot;) &amp; Code.ToString() R = System.Web.Security.FormsAuthentication.HashPasswordForStoringInConfigFile(R, &quot;MD5&quot;).ToUpper() R = R.Substring(0, Int32.Parse(System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.CodeLength&quot;))) Return R End Function Private Sub CustomValidator1_ServerValidate(ByVal source As System.Object, ByVal args As System.Web.UI.WebControls.ServerValidateEventArgs) Handles CustomValidator1.ServerValidate args.IsValid = args.Value.ToUpper() = GetVerificationString(CType(Me.ViewState(&quot;Code&quot;), Int32)) If Not args.IsValid Then ' If code is not correct, generate new Dim Code As Int32 = Me.Rnd.Next() Me.ViewState(&quot;Code&quot;) = Code Me.ImageCode.ImageUrl = System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.ImageGenerator&quot;) &amp; &quot;?Code=&quot; &amp; Code Me.TextBoxCode.Text = &quot;&quot; End If End Sub</p>
<p>Za zmínku stojí funkce <code>GetVerificationString()</code> která na základě předaného čísla spočítá ověřovací řetězec. Ta je pak volána ze stránky generující obrázek.</p>
<h3 id="generator-obrazku-humanfilterimagegenerator.aspx-humanfilterimagegenerator.aspx.vb">Generátor obrázku - HumanFilterImageGenerator.aspx, HumanFilterImageGenerator.aspx.vb</h3>
<p>Tato stránka zcela samostatně zajišťuje generování obrázku. Metodou GET je jí předán parametr <code>Code</code>, což je numerický kód použitý pro tvorbu ověřovacího řetězce. Veškerou práci odvádí backend, protože stránka negeneruje HTML kód, ale jenom obrázek ve formátu PNG:</p>
<p>Private Rnd As New Random Private Sub Page_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load ' Get verification string Dim Code As String = HumanFilter.GetVerificationString(Int32.Parse(Request.QueryString(&quot;Code&quot;))) ' Create bitmap Dim BMP As New System.Drawing.Bitmap(Code.Length * 20, 30) Dim GPH As System.Drawing.Graphics = System.Drawing.Graphics.FromImage(BMP) GPH.FillRectangle(New System.Drawing.SolidBrush(System.Drawing.Color.White), 0, 0, BMP.Width, BMP.Height) ' Draw noise For I As Int32 = 1 To BMP.Width * BMP.Height \ 15 BMP.SetPixel(Me.Rnd.Next(0, BMP.Width), Me.Rnd.Next(0, BMP.Height), Me.GenerateRandomColor) Next ' Draw letters For I As Int32 = 0 To Code.Length - 1 ' Random font Dim F As System.Drawing.Font = Me.GenerateRandomFont() Dim S As System.Drawing.Size = GPH.MeasureString(Code.Chars(I), F).ToSize() Dim P As New System.Drawing.PointF(20 * I + 10 - S.Width \ 2, 15 - S.Height \ 2) ' Random color Dim B As New System.Drawing.SolidBrush(Me.GenerateRandomColor()) ' Write to image GPH.DrawString(Code.Chars(I), F, B, P) Next ' Generate PNG from image Dim MS As New System.IO.MemoryStream BMP.Save(MS, System.Drawing.Imaging.ImageFormat.Png) BMP.Dispose() GPH.Dispose() ' Disable all caching Response.Cache.SetCacheability(Web.HttpCacheability.NoCache) Response.ExpiresAbsolute = DateTime.MinValue ' Flush image to client Response.Clear() Response.ContentType = &quot;image/png&quot; MS.WriteTo(Response.OutputStream) MS.Close() Response.End() End Sub Private Function GenerateRandomColor() As System.Drawing.Color Return System.Drawing.Color.FromArgb(Me.Rnd.Next(200), Me.Rnd.Next(200), Me.Rnd.Next(200)) End Function Private Function GenerateRandomFont() As System.Drawing.Font Dim Fonts() As String = System.Configuration.ConfigurationSettings.AppSettings(&quot;HumanFilter.Fonts&quot;).Split(Char.Parse(&quot;;&quot;)) Return New System.Drawing.Font(Fonts(Me.Rnd.Next(Fonts.Length)), Me.Rnd.Next(16, 36), Drawing.FontStyle.Regular, Drawing.GraphicsUnit.Pixel) End Function</p>
<p>Princip generování obrázku je předpokládám zřejmý z předchozího textu a komentářů v kódu. Kód obsahuje dvě obslužné funkce, které vygenerují náhodný font a náhodnou barvu. Funkce pro generování barvy je sestavena tak, že žádná z RGB barevných složek nemůže mít hodnotu vyšší než 200, čímž je zajištěno, že barvy budou čitelné na bílém pozadí (nebudou příliš světlé).</p>
<p>Teoreticky korektnější postup by byl použít místo RGB barevného modelu HSL (dá se v něm přímo regulovat sytost barvy), ale na to jsem příliš líný. Odhadologicky stanovená hodnota 200 se v praxi osvědčila, stejně jako patnáctiprocentní zastoupení šumu o pár řádek výše.</p>
<h2 id="ukazka-pouziti">Ukázka použití</h2>
<p>V případě použití se nevyžaduje nižádná větší aktivia, než umístění prvku do kontrolovaného formuláře a použití standardní validace, vše funguje zcela samostatně. Ukázkový kód (<code>Default.aspx</code>) je níže.</p>
<p>ASPX - frontend:</p>
<p>&lt;%@ Register TagPrefix=&quot;uc1&quot; TagName=&quot;HumanFilter&quot; Src=&quot;HumanFilter.ascx&quot; %&gt; <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"> <html> <head> <title>Default</title> <meta name="GENERATOR" content="Microsoft Visual Studio .NET 7.1"> <meta name="CODE_LANGUAGE" content="Visual Basic .NET 7.1"> <meta name="vs_defaultClientScript" content="JavaScript"> <meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5"> </head> <body> <form id="Form1" method="post" runat="server"> &lt;asp:label id=&quot;LabelPrompt&quot; runat=&quot;server&quot;&gt;Opište ověřovací kód do textového pole. Pokud kód nedokážete přečíst, zkuste ho odhadnout - bude-li chybný, zobrazí se po odeslání jiný obrázek.&lt;/asp:label&gt; &lt;asp:panel id=&quot;PanelForm&quot; runat=&quot;server&quot;&gt; <p> &lt;uc1:humanfilter id=&quot;HumanFilter1&quot; runat=&quot;server&quot;&gt;&lt;/uc1:humanfilter&gt;</p> <p> &lt;asp:validationsummary id=&quot;ValidationSummary1&quot; runat=&quot;server&quot;&gt;&lt;/asp:validationsummary&gt;</p> <p> &lt;asp:button id=&quot;ButtonSubmit&quot; runat=&quot;server&quot; text=&quot;Odeslat&quot;&gt;&lt;/asp:button&gt;</p> &lt;/asp:panel&gt; </form> </body> </html></p>
<p>VB.NET - backend:</p>
<p>Private Sub ButtonSubmit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ButtonSubmit.Click If Not Page.IsValid Then Return Me.PanelForm.Visible = False Me.LabelPrompt.Text = &quot;Formulář byl úspěšně odeslán&quot; End Sub</p>
<h2 id="upozorneni-na-zaver">Upozornění na závěr</h2>
<p>Technologii máte k dispozici, odkaz na kompletní zdrojový kód ke stažení jest níže. Než se ji ale rozhodnete na některém svém webu nasadit, mějte na paměti dvě věci.</p>
<p><strong>Dobrého pomálu.</strong> Kontrolu používejte jenom v případech, kdy je to opravdu nutné. Pokud se stanete cílem spamu nebo ve výjimečných případech (registrace apod.). Pokud z opisování kódu učiníte atrakci každého formuláře, uživatele to bude silně otravovat. To je důvod, proč až na další nenajdete tuto formu ověřování na tomto weblogu.</p>
<p><strong>Pozor na přístupnost.</strong> Splnění tohoto testu je jednoduché pro zdravého člověka. Nevidomý s hlasovou čtečkou je v koncích úplně, špatně vidící uživatelé s ním mohou mít problémy. Pokud je váš web důležitý a takto chráněná funkce pro jeho užití nezbytná, měli byste poskytnout alternativní formu ověření - třeba telefonickou.</p>
<h2 id="odkazy">Odkazy</h2>
<ul>
<li><a href="https://www.cdn.altairis.cz/Blog/2005/20050104-HumanFilter.zip">Zdrojové kódy ke stažení</a> (9 kB) <a href="http://www.w3.org/TR/turingtest/">Inaccessibility of Visually-Oriented Anti-Robot Tests</a> - obsáhlejší teoretické pojednání o tomto typu testů na webu W3C se zřetelem na přístupnost</li>
</ul>

      </section>
    </main>
    <footer>
      Footer
    </footer>
  </body>
</html>