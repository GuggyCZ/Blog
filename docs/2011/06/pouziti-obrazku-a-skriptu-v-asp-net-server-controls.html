<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Použití obrázků a skriptů v ASP.NET server controls | ALTAIR.blog</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <meta name="Description" content="Při tvorbě webových komponent často potřebujeme mít k dispozici jistá externí data, jako například obrázky, skripty, CSS stylesheety a podobně. Nepochybně je můžete přibalit ke své knihovně a požadovat, aby byly nakopírovány na patřičná místa cílové aplikace, ale to není právě nejlepší řešení. ASP.NET disponuje několika technikami, které umožňují tento problém řešit. Popsal jsem je v článku (v angličtině) pro server CodeProject." />
    <link rel="stylesheet" type="text/css" href="/content/styles.min.css" />
    <link rel="alternate" type="application/rss+xml" href="/feed.rss" title="RSS Feed" />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/content/images/logo_onwhite.svg" alt="altair.blog" style="height:100px;" />
        </a>
      </div>
    </header>
    <main>
      <h1>Použití obrázků a skriptů v ASP.NET server controls</h1>
      <section class="article">
        <p>Web components (such as ASP.NET Web Controls), often need to contain or access binary data, such as images, style sheets and JavaScript. Of course you can package them loose with your assembly and force developers to copy them to places where your components would expect them. But that’s a deployment nightmare and sometimes it’s not even possible.</p>
<p>Here ASP.NET WebResources come to the rescue, but at some cost and with some drawbacks on its own. In this article I will describe how you can use WebResources a how you can minimize the drawbacks with data URIs and content delivery networks.</p>
<h2 id="using-webresources-in-asp.net">Using WebResources in ASP.NET</h2>
<p>The web resource mechanism allows you to compile any data (such as images, CSS and JavaScript files) into your assembly. You can request the embedded resources using special handler, which is part of .NET Framework.</p>
<p>The main advantage of this feature is smaller number of files you need to deploy. The typical examples are icon libraries. You can easily get some library, such as the Silk Icon Set (<a href="http://www.famfamfam.com/lab/icons/silk/">http://www.famfamfam.com/lab/icons/silk/</a>), but then you need to maintain and carry with you bunch of quite small but numerous icons. Some things in life can never be fully appreciated nor understood unless experienced firsthand. Copying the complete set of 1000 Silk icons to FTP server in hurry and over unstable connection is one of them.</p>
<p>The process is actually quite simple, but is prone to errors, typos and misunderstandings, which do not manifest as error messages or exceptions. It simply does not work and you don’t know why.</p>
<p>This article offers step-by-step guide for how to create simple web control library with embedded resources.</p>
<h3 id="preparing-the-files">Preparing the files</h3>
<p>First, create special folder for the files, you want to include in your assembly. It’s usually called <code>Resources</code> and lies in root of your project, but you may name and place it anywhere in your structure. Put your files there. When including multiple files, the easiest way is to drag them from Explorer window to the Solution Explorer in Visual Studio.</p>
<p>Then you need to mark all these files as <em>Embedded Resources</em>. Select all the files (you may select multiple files) and in the Properties window set the Build Action to <em>Embedded Resource</em> (not just <em>Resource</em>).</p>
<h3 id="registering-the-web-resources">Registering the web resources</h3>
<p>Next step is registering the resource as WebResource. You can do it in any code file (C# or VB.NET) using the <code>WebResource</code> attribute. It does not really matter where you place the attribute, but I usually create file called <code>_ResourceRegistration.cs</code> in the folder, where the embedded files are placed (the underscore ensures that the file is on top of the list when sorted alphabetically).</p>
<p>The following is sample <code>_ResourceRegistration.cs</code> file, registering single image:</p>
<p>using System.Web.UI; [assembly: WebResource(&quot;Altairis.ResourceDemo.Controls.Resources.FlagBlue.png&quot;, &quot;image/png&quot;)]</p>
<p>The first argument of the attribute definition is logical name of the resource. The logical name is the most problematic part of resource registration, because it must match exactly your project settings and file name. The logical name is case sensitive, even though it contains file names, which are generally not case sensitive. Problem in its definition would not cause any compilation or runtime error, it just won’t work.</p>
<p>The logical name consists of three parts, which are concatenated and separated by dot. First part is the root namespace of your project. The root namespace is set in project properties (Application tab) and by default matches project name. In the above example the root namespace is <code>Altairis.ResourceDemo.Controls</code>.</p>
<p>Second part is the path within project folder structure. In our case, the files are placed in the Resources folder in the root of project; therefore the part of the name is just <code>Resources</code>. In more complex structures, dot is used as path separator. The third and last part is file name, including extension. In the above example it’s <code>FlagBlue.png</code>.</p>
<p>Second argument is MIME type of the content. When requested using the WebResource.axd handler, the type is sent as Content-Type HTTP header and may be important from the web browser standpoint. The most common MIME types are <code>image/png</code>, <code>image/gif</code> and <code>image/jpeg</code> for image formats, <code>text/javascript</code> for JavaScript and <code>text/css</code> for style sheets.</p>
<h3 id="getting-the-resource-url">Getting the resource URL</h3>
<p>The last step is to get the final resource URL, on which your embedded data can be accessed. This can be done by calling method <code>Page.ClientScript.GetWebResourceUrl</code>. The method has two arguments: first is the type to which the resource is related, usually the control using it. Second one is the logical name of resource. You may get path to the above resource by calling:</p>
<p>var imageLink = this.Page.ClientScript.GetWebResourceUrl(this.GetType(), &quot;Altairis.ResourceDemo.Controls.Resources.FlagBlue.png&quot;);</p>
<p>The resulting paths points to the <code>~/WebResource.axd</code> handler and looks similar to the following:</p>
<p>/WebResource.axd?d=dseRjrCHl7PvN70cMzoiaJKEsWjA2FTOp8sEou4qLQKJBO_kc1b3cnhEI6E-eWw poXM-z4_GG5ApZbQR4SIsEOcpPyodXAeRk7ZKg-YQLxdLqIcBtUWb5mRQ-82wT8Pe2MxOiYZOyAN3dUvEj bsvhqPfDjQdtgCF4HtTkdsrUF9XBmnkjvja_B1l9bG0GZce0&amp; t=634317785760223219</p>
<p>The long Base-64 encoded query string parameter is encrypted logical name of the resource and the assembly where it’s contained.</p>
<h2 id="content-delivery-networks-cdn">Content Delivery Networks (CDN)</h2>
<p>The above mechanism is used in the ASP.NET Web Forms infrastructure itself. For example, the helper JavaScript files used by validation controls (such as <code>RequiredFieldValidator</code>, <code>RegularExpressionValidator</code> etc.) are loaded this way.</p>
<p>With release of ASP.NET 4.0, Microsoft launched its own Content Delivery Network (CDN). All the files required by ASP.NET infrastructure, as well as jQuery and some jQuery plugins, are hosted on ajax.aspnetcdn.com. Full list of the CDN files can be found at the following address: <a href="http://www.asp.net/ajaxlibrary/cdn.ashx">http://www.asp.net/ajaxlibrary/cdn.ashx</a>.</p>
<p>The main reason for using content delivery networks is performance. The CDN consists of many servers placed in different parts of the world and the user’s request is routed to the nearest edge cache server, which may be reachable more quickly than your own server. Also the CDN resources are cached by browser. When different ASP.NET applications use the same support scripts, they aren’t loaded many times (like when they are requested separately from each web site), but only once from the shared location.</p>
<p>To enable ASP.NET CDN for the core server controls, place <code>ScriptManager</code> control to your page and set its <code>EnableCdn</code> property to <code>true</code>. If you don’t use Microsoft AJAX Framework, you can disable its automatic referencing as well:</p>
<p>&lt;asp:scriptmanager runat=&quot;server&quot; enablecdn=&quot;true&quot; ajaxframeworkmode=&quot;Disabled&quot; /&gt;</p>
<h3 id="using-cdn-with-web-resources">Using CDN with web resources</h3>
<p>If you are for example component vendor, you might want to use similar technique for distributing your resources. You might want to run your own CDN and reference the embedded resources from there.</p>
<p>It’s however not good idea to simply hardcode the CDN paths into your components and force users to use them. CDNs are not welcome in some scenarios, such as intranet applications, where access to Internet is limited, or offline development. It’s therefore recommended to do as Microsoft does: allow developers to turn the CDN on and off using the ScriptManager control.</p>
<p>When registering the resources, you might use additional named argument of the <code>WebResource</code> attribute, called <code>CdnPath</code>, which contains the full path to where the resource file is located in your CDN. When <code>EnableCdn</code> is set to <code>true</code>, the CDN link is issued instead to call to WebResource.axd.</p>
<p>The above sample can be modified as follows:</p>
<p>using System.Web.UI; [assembly: WebResource(&quot;Altairis.ResourceDemo.Controls.Resources.FlagBlue.png&quot;, &quot;image/png&quot;, CdnPath = &quot;http://yourcdn/Samples/EmbeddingResources/FlagBlue.png&quot;)]</p>
<p>ASP.NET won’t help you with building the CDN itself, it would just link to it. To build CDN, you can use various ways starting with easy and free solutions like CloudFlare (<a href="http://www.cloudflare.com">www.cloudflare.com</a>), over paid services of big providers like Akamai and ending with deploying your own server farms worldwide, that’s up to you.</p>
<h3 id="using-ssl-with-cdn">Using SSL with CDN</h3>
<p>Usage of CDNs can be problematic when your application uses encrypted connection – HTTPS or SSL/TLS. Referencing unsecured content from secured page is security risks and browsers would display miscellaneous annoying warnings to users.</p>
<p>In the default settings, CDN would be used only when the page is requested using nonsecured connection. If SSL is employed, the link would fall back to the WebResource.axd approach.</p>
<p>If your CDN offers HTTPS connection as well, you may indicate it by adding additional argument called <code>CdnSupportsSecureConnection</code> set to <code>true</code>. The registration would then look similar to:</p>
<p>[assembly: WebResource(&quot;Altairis.ResourceDemo.Controls.Resources.FlagBlue.png&quot;, &quot;image/png&quot;, CdnPath = &quot;http://yourcdn/Samples/EmbeddingResources/FlagBlue.png&quot;, CdnSupportsSecureConnection = true)]</p>
<p>When this argument is set to <code>true</code> and page is requested using HTTPS, the <code>CdnPath</code> is modified to use HTTPS as well. In the above example the link would thus begin with <code>https://yourcdn/…</code></p>
<h2 id="data-uri-scheme">Data URI scheme</h2>
<p>Sometimes you can avoid use of the web resources altogether using the data URIs. Commonly, the URI contains HTTP address, which identifies the object (Uniform Resource Identifier) and usually also locates it, gives address where the object can be located.</p>
<p>In case of Data URIs, the object itself is contained within the URI. This approach is most often used for small images, such as icons, where the binary image data are embedded in Base64 encoded form in the URI itself. See the following example (shortened for readability):</p>
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB………QCAYAAAAf8/9h=" />
<p>The structure of Data URI is formally defined in RFC2397, but usually takes the form shown above. It starts with the “<code>data:</code>” scheme prefix followed by content type of the data (here “<code>image/png</code>”, as discussed above), semicolon, encoding type (“<code>base64</code>”), colon and the Base64-encoded binary data.</p>
<p>The main advantage of using Data URIs is limiting number of HTTP requests. If your page uses lots of small images, displaying it in browser may involve quite a number of HTTP requests. Although the amount of data itself is not big, the overhead is quite significant. By embedding the data in page itself, you limit number of requests. In addition to lower the transaction costs, limiting number of request lowers the load of the web server.</p>
<p>The main disadvantage is that Base64-encoded data are by 1/3 bigger than in their binary form. Also, when used the naive way outlined above, when used repeatedly in page, they must be repeated each time.</p>
<h3 id="using-style-sheets-with-data-uri-scheme">Using style sheets with data URI scheme</h3>
<p>The second disadvantage, repeating occurrences of the particular image, can be easily solved by not referencing the data directly using the “<code>src</code>” attribute, but using CSS classes and contain the image data in style sheet file.</p>
<p>To display red flag icon, we might define the following HTML in page itself:</p>
<p><span class="redflag"></span></p>
<p>Then we define the following markup in the page style sheet (again, the Base64 data are trimmed for readability):</p>
<p>.redflag { display: inline-block; width: 16px; height: 16px; background-position: center center; background-repeat: no-repeat; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAA…); }</p>
<h2 id="the-complete-example">The complete example</h2>
<p>All the methods shown in this article are combined in sample application you can download. The source code contains two projects: <code>Altairis.ResourceDemo.Controls</code> is a class library, containing single web control and a bunch of resources. Second project is a sample web site, using the control library.</p>
<p>We define single web control, called <code>FlagIcon</code>. The control displays one of seven colored flag images, contained in the Silk icon set already mentioned in this article. The control has two interesting properties:</p>
<p><code>FlagColor</code> is enum containing all available flag colors and defines which image is going to be displayed.</p>
<p><code>LinkMode</code> controls the means by which the image is displayed. When set to <code>WebResource</code>, the embedded resources or CDN are used. When set to <code>DataUri</code>, the picture is inlined into HTML as Data URI. Third possible value is <code>StyleSheet</code>, which combines the approaches.</p>
<h3 id="combining-web-resources-and-data-uris">Combining web resources and Data URIs</h3>
<p>The last method combines the techniques mentioned here and tries to maximize the gains and minimize the losses.</p>
<p>The core is style sheet, containing inlined all seven images. The style sheet is compiled in the component library as web resource, as well as available through the Altairis Content Delivery Network.</p>
<p>The main challenge there is to reference the style sheet in page and do this only once, even when the page contains multiple icons. That’s what the <code>EnsureStyleSheetRegistration</code> method I developed is good for:</p>
<p>private void EnsureStyleSheetRegistration() { // We need <head runat="server"> for this code to work if (this.Page.Header == null) throw new NotSupportedException(&quot;No &lt;head runat=&quot;server&quot;&gt; control found in page.&quot;); // Get the stylesheet resource URL var styleSheetUrl = this.Page.ClientScript.GetWebResourceUrl(this.GetType(), STYLE_RESOURCE_NAME); // Check if this stylesheer is already registered var alreadyRegistered = this.Page.Header.Controls.OfType<HtmlLink>().Any(x =&gt; x.Href.Equals(styleSheetUrl)); if (alreadyRegistered) return; // no work here // If not, register it var link = new HtmlLink(); link.Attributes[&quot;rel&quot;] = &quot;stylesheet&quot;; link.Attributes[&quot;type&quot;] = &quot;text/css&quot;; link.Attributes[&quot;href&quot;] = styleSheetUrl; this.Page.Header.Controls.Add(link); }</p>
<h2 id="conclusion">Conclusion</h2>
<p>ASP.NET offers nice mechanism for embedding resources, such as images, style sheets or JavaScript, into assemblies and reading them via the WebResource.axd handler. In case of small images, inlining them using Data URIs may be better alternative. Many negatives of inlining may be solved by combining the above methods and define inlined images in style sheets.</p>
<p>Another alternative, not discussed in this article, is use of image sprites. If you want to explore this idea in ASP.NET, there is a Sprite and Image Optimization Framework project available in ASP.NET Futures on CodePlex: <a href="http://aspnet.codeplex.com/releases/view/50869">http://aspnet.codeplex.com/releases/view/50869</a>.</p>

      </section>
    </main>
    <footer>
      Footer
    </footer>
  </body>
</html>