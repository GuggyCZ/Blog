<!-- dcterms:identifier = aspnetcz#249 -->
<!-- dcterms:title = Automatizovaná záloha všech databází na SQL Express -->
<!-- dcterms:abstract = Express edice SQL Serveru 2008 je dostatečně robustní pro běh řady aplikací, přestože je dostupná zdarma. Většímu nasazení mnohdy brání absence SQL Agenta a Maintenance plánů, které u "velkého" SQL serveru zajišťují automatizovanou údržbu a zálohu databází. S trochou šikovnosti lze ale databáze automaticky zálohovat i u Express edice. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = Programování -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2009-12-25T22:54:22.793+01:00 -->
<!-- dcterms:dateAccepted = 2009-12-25T22:54:22.793+01:00 -->

<p>Express edice SQL Serveru 2008 je dostatečně robustní pro běh řady aplikací, přestože je dostupná zdarma. Většímu nasazení mnohdy brání absence SQL Agenta a Maintenance plánů, které u &quot;velkého&quot; SQL serveru zajišťují automatizovanou údržbu a zálohu databází. S trochou šikovnosti lze ale databáze automaticky zálohovat i u Express edice.</p>  <p>Maintenance plány fungují tak, že vám umožní například zazálohovat všechny databáze nebo na nich provést nějaké údržbové úkoly. SQL Server Agent, který se o ně stará, je jakýsi &quot;task scheduler&quot;, který žije uvnitř SQL Serveru a stará se o automatické spouštění úloh.</p>  <p>Express edice nic takového nemá a pokud chceme například automaticky zálohovat všechny databáze, je třeba to naskriptovat vlastními silami. Princip fungování je velmi jednoduchý: V první řadě vytvoříme SQL dávku, která při spuštění projede seznam všech databází a pomocí příkazu BACKUP DATABASE je zazálohuje. Ve druhé řadě pak napíšeme dávkový soubor (CMD), ve kterém pomocí utility SQLCMD dříve vytvořený SQL skript spustíme. Aby se nám zálohy na disku nehromadily až do jeho úplného zaplnění, automaticky rovněž smažeme všechny záložní soubory, které jsou starší než definovaný počet dnů. Tento dávkový soubor pak pomocí systémového task scheduleru spustíme například jednou za den.</p>  <h2>ExpressBackup.sql</h2>  <p>Takhle bude vypadat soubor <em>ExpressBackup.sql</em>, který provede vlastní zálohování:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px"><span style="color: green">/******************************************************************************</span></p>    <p style="margin: 0px"><span style="color: green">** ALL DATABASE BACKUP SCRIPT FOR MICROSOFT SQL SERVER EXPRESS EDITION 2008&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">** Copyright (c) Michal A. Valasek, Altairis, 2009&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">** http://www.aspnet.cz/ | http://www.altairis.cz/ | http://www.rider.cz/&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">** ------------------------------------------------------------------------- **</span></p>    <p style="margin: 0px"><span style="color: green">** When running from command line:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">**&#160; - set BackupFilePath environment variable&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">**&#160; - see ExpressBackup.cmd for example&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">** When running from SQL management studio:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">**&#160; - enable Query -&gt; SQLCMD mode&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">**&#160; - uncomment the &quot;:setvar&quot; line below and specify path&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; **</span></p>    <p style="margin: 0px"><span style="color: green">******************************************************************************/</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">-- :setvar BackupFilePath &quot;D:\SqlBackup\&quot; -- include trailing backslash!!</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">-- Declare variables used in the script</span></p>    <p style="margin: 0px"><span style="color: blue">DECLARE</span> </p>    <p style="margin: 0px">&#160; <span style="color: teal">@timestamp</span> <span style="color: blue">AS</span> <span style="color: blue">nvarchar</span><span style="color: gray">(</span><span style="color: #a52a2a">20</span><span style="color: gray">),</span></p>    <p style="margin: 0px">&#160; <span style="color: teal">@current_id</span> <span style="color: blue">AS</span> <span style="color: blue">int</span><span style="color: gray">,</span> </p>    <p style="margin: 0px">&#160; <span style="color: teal">@current_name</span> <span style="color: blue">AS</span> <span style="color: blue">nvarchar</span><span style="color: gray">(</span><span style="color: fuchsia">max</span><span style="color: gray">),</span></p>    <p style="margin: 0px">&#160; <span style="color: teal">@current_file</span> <span style="color: blue">AS</span> <span style="color: blue">nvarchar</span><span style="color: gray">(</span><span style="color: fuchsia">max</span><span style="color: gray">)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">-- Create file name timestamp (YYYYMMDD_hhmmss format)</span></p>    <p style="margin: 0px"><span style="color: blue">SET</span> <span style="color: teal">@timestamp</span> <span style="color: gray">=</span> <span style="color: fuchsia">CONVERT</span><span style="color: gray">(</span><span style="color: blue">nvarchar</span><span style="color: gray">,</span> <span style="color: fuchsia">GETDATE</span><span style="color: gray">(),</span> <span style="color: #a52a2a">20</span><span style="color: gray">)</span></p>    <p style="margin: 0px"><span style="color: blue">SET</span> <span style="color: teal">@timestamp</span> <span style="color: gray">=</span> <span style="color: fuchsia">REPLACE</span><span style="color: gray">(</span><span style="color: teal">@timestamp</span><span style="color: gray">,</span> <span style="color: red">'-'</span><span style="color: gray">,</span> <span style="color: red">''</span><span style="color: gray">)</span></p>    <p style="margin: 0px"><span style="color: blue">SET</span> <span style="color: teal">@timestamp</span> <span style="color: gray">=</span> <span style="color: fuchsia">REPLACE</span><span style="color: gray">(</span><span style="color: teal">@timestamp</span><span style="color: gray">,</span> <span style="color: red">':'</span><span style="color: gray">,</span> <span style="color: red">''</span><span style="color: gray">)</span></p>    <p style="margin: 0px"><span style="color: blue">SET</span> <span style="color: teal">@timestamp</span> <span style="color: gray">=</span> <span style="color: fuchsia">REPLACE</span><span style="color: gray">(</span><span style="color: teal">@timestamp</span><span style="color: gray">,</span> <span style="color: red">' '</span><span style="color: gray">,</span> <span style="color: red">'_'</span><span style="color: gray">)</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">-- Get initial database ID</span></p>    <p style="margin: 0px"><span style="color: blue">SELECT</span> <span style="color: teal">@current_id</span> <span style="color: gray">=</span> <span style="color: fuchsia">MIN</span><span style="color: gray">(</span><span style="color: teal">database_id</span><span style="color: gray">)</span> <span style="color: blue">FROM</span> <span style="color: lime">sys</span><span style="color: gray">.</span><span style="color: lime">databases</span> <span style="color: blue">WHERE</span> <span style="color: teal">name</span> <span style="color: gray">&lt;&gt;</span> <span style="color: red">'tempdb'</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: green">-- Go trough all databases</span></p>    <p style="margin: 0px"><span style="color: blue">WHILE</span> <span style="color: teal">@current_id</span> <span style="color: gray">IS</span> <span style="color: gray">NOT</span> <span style="color: gray">NULL</span> <span style="color: blue">BEGIN</span></p>    <p style="margin: 0px">&#160; <span style="color: green">-- Get database name and backup file</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">SELECT</span> <span style="color: teal">@current_name</span> <span style="color: gray">=</span> <span style="color: teal">name</span> <span style="color: blue">FROM</span> <span style="color: lime">sys</span><span style="color: gray">.</span><span style="color: lime">databases</span> <span style="color: blue">WHERE</span> <span style="color: teal">database_id</span> <span style="color: gray">=</span> <span style="color: teal">@current_id</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">SET</span> <span style="color: teal">@current_file</span> <span style="color: gray">=</span> <span style="color: red">'$(BackupFilePath)'</span> <span style="color: gray">+</span> <span style="color: teal">@current_name</span> <span style="color: gray">+</span> <span style="color: red">'_'</span> <span style="color: gray">+</span> <span style="color: teal">@timestamp</span> <span style="color: gray">+</span> <span style="color: red">'.bak'</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">-- Backup database</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">PRINT</span> <span style="color: red">'Backing up database '</span> <span style="color: gray">+</span> <span style="color: teal">@current_name</span> <span style="color: gray">+</span> <span style="color: red">' to '</span> <span style="color: gray">+</span> <span style="color: teal">@current_file</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">BACKUP</span> <span style="color: blue">DATABASE</span> <span style="color: teal">@current_name</span> <span style="color: blue">TO</span>&#160; <span style="color: blue">DISK</span> <span style="color: gray">=</span> <span style="color: teal">@current_file</span> <span style="color: blue">WITH</span> <span style="color: blue">NOINIT</span></p>    <p style="margin: 0px">&#160; <span style="color: blue">PRINT</span> <span style="color: gray">NULL</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160; <span style="color: green">-- Get next database</span></p>    <p style="margin: 0px"><span style="color: blue">&#160; SELECT</span> <span style="color: teal">@current_id</span> <span style="color: gray">=</span> <span style="color: fuchsia">MIN</span><span style="color: gray">(</span><span style="color: teal">database_id</span><span style="color: gray">)</span> <span style="color: blue">FROM</span> <span style="color: lime">sys</span><span style="color: gray">.</span><span style="color: lime">databases</span> <span style="color: blue">WHERE</span> <span style="color: teal">name</span> <span style="color: gray">&lt;&gt;</span> <span style="color: red">'tempdb'</span> <span style="color: gray">AND</span> <span style="color: teal">database_id</span> <span style="color: gray">&gt;</span> <span style="color: teal">@current_id</span></p>    <p style="margin: 0px"><span style="color: blue">END</span></p> </div>  <p>Tato dávka postupně zazálohuje všechny databáze do souboru &quot;NázevDB_YYYYMMDD_hhmmss.bak&quot; ve složce určené SQLCMD proměnnou &quot;BackupFilePath&quot;. Výše uvedený skript není primárně určen k tou, aby byl spouštěn interaktivně z Management Studia (i když i to je možné, pokud zapneme SQLCMD režim, viz komentář), ale právě ke spuštění pomocí řádkové utility SQLCMD. V takovém případě se konstrukce <em>$(NázevProměnné)</em> ve skriptu zamění za hodnotu systémové proměnné <em>NázevProměnné</em>.</p>  <h2>ExpressBackup.cmd</h2>  <p>To je myslím hezky vidět v souboru <em>ExpressBackup.cmd</em>, který dělá v podstatě jenom tři věci: nastaví systémovou proměnnou, zavolá výše uvedenou SQL dávku a poté vymaže všechny záložní soubory starší než 7 dnů (posuzuje to podle data poslední změny souboru, ne podle jeho názvu).</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px">@ECHO OFF</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">REM -- Set path to backup databases to - referenced from the SQL script</p>    <p style="margin: 0px">REM -- This path must include trailing backslash!</p>    <p style="margin: 0px">SET BackupFilePath=D:\SqlBackup\</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">REM -- Call SQLCMD with parameters needed to connect to SQL Server</p>    <p style="margin: 0px">SQLCMD -S .\SqlExpress -E -i ExpressBackup.sql</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">REM -- Delete all backup files older than 7 days</p>    <p style="margin: 0px">ECHO Deleting backups older than 7 days...</p>    <p style="margin: 0px">FORFILES /P %BackupFilePath% /M *.bak /D -7 /C &quot;CMD /C DEL /Q @FILE&quot;</p> </div>  <p>Tento soubor (zejména cestu k záložním souborům a volání SQLCMD) si můžete upravit dle potřeby.</p>  <p>Poslední krok pak spočívá v tom, že soubor <em>ExpressBackup.cmd</em> zavoláte jednou za den pomocí systémového plánovače úloh.</p>  <p>  <p>Ačkoliv je tento návod ušit na míru Express edici, můžete ho v případě nutnosti použít i na vyšší edice. Nicméně obecně to nedoporučuji, SQL Server Agent umí mnohem víc a vyplatí se s ním naučit zacházet.</p>